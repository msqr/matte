<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Matte: Theme HOWTO: Album View</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="whoosh-matte.css" />
	<link type="text/css" rel="stylesheet" href="css/SyntaxHighlighter.css"></link>
	<script type="text/javascript" src="js/shCore.js"></script>
	<script type="text/javascript" src="js/shBrushJScript.js"></script>
	<script type="text/javascript" src="js/shBrushXml.js"></script>
</head>
<body class="full">

<h1><a name="top"></a>Matte: Theme HOWTO: Album View</h1>

<div class="pagenav">
	<ul>
		<li><a href="theme-howto.html">Overview</a></li>
		<li><a href="theme-howto-browse.html">Browse View</a></li>
		<li>Album View</li>
		<li><a href="theme-howto-detail.html">Detail View</a></li>
	</ul>
</div>

<p>The Matte album view allows people to view the media items within a shared album.
In many ways it is analogous to an album slide show. The primary purpose of the album
view is to allow a user to view the media items within an album. Thus it must provide 
a way for the user to move between the items within the album in some way, and can 
also support showing detailed information about each item.</p>

<div class="screenshot">
	<img src="img/th2-album-example-full.png" alt="Woosh Browse Theme" width="493" height="282" />
	<div>An album in the Woosh browse view.</div>
</div>

<h2>Sample album data model</h2>

<p>The album data model includes the album the item is shared in
(a <code>&lt;m:album&gt;</code> element). The album will have the items within the album
available (as child <code>&lt;m:item&gt;</code> elements) but those items will <b>not</b>
have their detailed metadata elements available (i.e. they will not have 
<code>&lt;m:metadata&gt;</code> elements).</p>


<p>Here is a sample of the album data model:</p>

<textarea name="code" rows="1" cols="80" class="xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;x:x-data xmlns:x="http://msqr.us/xsd/jaxb-web" xmlns:m="http://msqr.us/xsd/matte"&gt;
  &lt;x:x-context&gt;
    &lt;x:server-name&gt;localhost&lt;/x:server-name&gt;
    &lt;x:server-port&gt;8080&lt;/x:server-port&gt;
    &lt;x:user-agent&gt;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.4) Gecko/20070515
      Firefox/2.0.0.4&lt;/x:user-agent&gt;
    &lt;x:user-locale&gt;en_US&lt;/x:user-locale&gt;
    &lt;x:web-context&gt;/matte&lt;/x:web-context&gt;
    &lt;x:path&gt;/album.do&lt;/x:path&gt;
  &lt;/x:x-context&gt;
  &lt;x:x-auxillary&gt;
    &lt;x:x-param key="display.album.key"&gt;2XlxVfKHja3CFGtMlyG57ofbchw&lt;/x:x-param&gt;
  &lt;/x:x-auxillary&gt;
  &lt;x:x-session&gt;
    &lt;m:session&gt;
      &lt;m:thumbnail-setting quality="GOOD" size="THUMB_NORMAL"/&gt;
      &lt;m:view-setting quality="GOOD" size="NORMAL"/&gt;
    &lt;/m:session&gt;
  &lt;/x:x-session&gt;
  &lt;x:x-request&gt;
    &lt;x:param key="key"&gt;2XlxVfKHja3CFGtMlyG57ofbchw&lt;/x:param&gt;
  &lt;/x:x-request&gt;
  &lt;x:x-request-headers&gt;
    &lt;x:param key="host"&gt;localhost&lt;/x:param&gt;
    &lt;x:param key="user-agent"&gt;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.4)
      Gecko/20070515 Firefox/2.0.0.4&lt;/x:param&gt;
    &lt;x:param key="accept"
      &gt;text/xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5&lt;/x:param&gt;
    &lt;x:param key="accept-language"&gt;en-us,en;q=0.5&lt;/x:param&gt;
    &lt;x:param key="accept-encoding"&gt;gzip,deflate&lt;/x:param&gt;
    &lt;x:param key="accept-charset"&gt;ISO-8859-1,utf-8;q=0.7,*;q=0.7&lt;/x:param&gt;
    &lt;x:param key="Keep-Alive"&gt;300&lt;/x:param&gt;
    &lt;x:param key="connection"&gt;keep-alive&lt;/x:param&gt;
    &lt;x:param key="cookie"&gt;cookies=true; JSESSIONID=69BB450E95FDBD01A29D4118920EBBAC;&lt;/x:param&gt;
    &lt;x:param key="content-length"&gt;0&lt;/x:param&gt;
  &lt;/x:x-request-headers&gt;
  &lt;x:x-model&gt;
    &lt;m:model&gt;
      &lt;m:media-size height="1200" size="BIGGEST" width="1600"/&gt;
      &lt;m:media-size height="768" size="BIGGER" width="1024"/&gt;
      &lt;m:media-size height="600" size="BIG" width="800"/&gt;
      &lt;m:media-size height="480" size="NORMAL" width="640"/&gt;
      &lt;m:media-size height="320" size="SMALL" width="480"/&gt;
      &lt;m:media-size height="240" size="TINY" width="320"/&gt;
      &lt;m:media-size height="180" size="THUMB_BIGGER" width="240"/&gt;
      &lt;m:media-size height="135" size="THUMB_BIG" width="180"/&gt;
      &lt;m:media-size height="90" size="THUMB_NORMAL" width="120"/&gt;
      &lt;m:media-size height="48" size="THUMB_SMALL" width="64"/&gt;
      &lt;m:album album-date="2006-06-01T00:00:00+12:00" album-id="21" allow-anonymous="true"
        allow-browse="true" allow-feed="true" allow-original="true"
        anonymous-key="2XlxVfKHja3CFGtMlyG57ofbchw"
        creation-date="2006-12-17T13:40:26.691+13:00" name="More John Muir Trail"
        sort-mode="0"&gt;
        &lt;m:comment&gt;These are photos from the John Muir Trail.&lt;/m:comment&gt;
        &lt;m:owner access-level="0" anonymous-key="db35b2faa3ad4527e76be12fba4ceab1"
          country="US" creation-date="2006-12-17T12:10:50.123+13:00" email="matt@localhost"
          language="en" login="matt" name="Matt"
          password="{SHA}Mv+VCPQnH3dNmi0W7qXI9nQCI78=" quota="0" user-id="3"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:thumbnail-setting quality="GOOD" size="THUMB_NORMAL"/&gt;
          &lt;m:view-setting quality="GOOD" size="NORMAL"/&gt;
          &lt;m:default-theme author="Matte Development Team" author-email="matte@noplace"
            base-path="/core/woosh" creation-date="2006-12-17T12:06:38.387+13:00"
            name="Woosh" theme-id="1"&gt;
            &lt;m:description&gt;Default theme.&lt;/m:description&gt;
          &lt;/m:default-theme&gt;
          &lt;m:browse-theme author="Matte Development Team" author-email="matte@noplace"
            base-path="/core/woosh" creation-date="2006-12-17T12:06:38.387+13:00"
            name="Woosh" theme-id="1"&gt;
            &lt;m:description&gt;Default theme.&lt;/m:description&gt;
          &lt;/m:browse-theme&gt;
        &lt;/m:owner&gt;
        &lt;m:theme author="Matte Development Team" author-email="matte@noplace"
          base-path="/core/woosh" creation-date="2006-12-17T12:06:38.387+13:00"
          name="Woosh" theme-id="1"&gt;
          &lt;m:description&gt;Default theme.&lt;/m:description&gt;
        &lt;/m:theme&gt;
        &lt;m:item creation-date="2006-12-17T13:35:09.608+13:00" display-order="0"
          file-size="96111" height="683" hits="6" item-id="8" mime="image/jpeg"
          name="_6A_1392.jpg" path="_6A_1392.jpg" use-icon="false" width="1024"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:tz-display code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
        &lt;/m:item&gt;
        &lt;m:item creation-date="2006-12-17T13:36:07.812+13:00" display-order="0"
          file-size="42628" height="683" hits="4" item-id="10" mime="image/jpeg"
          name="IMG_0868.jpg" path="IMG_0868.jpg" use-icon="false" width="1024"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:tz-display code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
        &lt;/m:item&gt;
        &lt;m:item creation-date="2006-12-17T13:37:20.746+13:00" display-order="0"
          file-size="66438" height="768" hits="2" item-id="12" mime="image/jpeg"
          name="IMG_0848.jpg" path="IMG_0848.jpg" use-icon="false" width="512"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:tz-display code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
        &lt;/m:item&gt;
        &lt;m:item creation-date="2006-12-17T13:37:35.716+13:00" display-order="0"
          file-size="91771" height="683" hits="3" item-id="14" mime="image/jpeg"
          name="_19_1404.jpg" path="_19_1404.jpg" use-icon="false" width="1024"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:tz-display code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
        &lt;/m:item&gt;
        &lt;m:item creation-date="2006-12-17T13:37:51.336+13:00" display-order="0"
          file-size="51705" height="683" hits="4" item-date="2006-12-18T13:37:51+13:00"
          item-id="16" mime="image/jpeg" name="IMG_0871.jpg" path="IMG_0871.jpg"
          use-icon="false" width="1024"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:tz-display code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
        &lt;/m:item&gt;
        &lt;m:item creation-date="2006-12-17T13:47:49.441+13:00" display-order="0"
          file-size="67498" height="768" hits="3" item-id="18" mime="image/jpeg"
          name="IMG_5164.jpg" path="IMG_5164.jpg" use-icon="false" width="512"&gt;
          &lt;m:tz code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
          &lt;m:tz-display code="Pacific/Auckland" name="Pacific/Auckland" offset="43200000"
            ordering="563"/&gt;
        &lt;/m:item&gt;
      &lt;/m:album&gt;
    &lt;/m:model&gt;
  &lt;/x:x-model&gt;
&lt;/x:x-data&gt;
</textarea>


<h2>Woosh - Dissection</h2>

<p>Here is a dissection of the Woosh album theme so you can see where the elements come from
the Matte XML data model.</p>

<div class="screenshot">
	<img src="img/th2-album-dissection.png" alt="Woosh Album View" width="777" height="565" />
	<div>An album in the Woosh album view.</div>
</div>

<p>The Woosh theme presents an album with all media items displayed as thumbnails in a 
scrolling widget at the top of the page (#3). Clicking on individual thumbnails loads a full-size
version of that item in the center of the page (#4), and also displays detailed information about 
that item in another widget on the right side of the page. (#5) Let's take a look at the numbered 
items from this snippet in more detail:</p>

<ol>
	<li>
		<p><b>Page title:</b> Woosh displays the album name and the 
		album date as the page title.</p>
	</li>
	<li>
		<p><b>Album date:</b> Albums can have a user-specifed date
		(the <code>@album-date</code> attribute). If the album has been 
		modified, it will have a <code>@modify-date</code>. An album will 
		always have a <code>@creation-date</code> for the date it was 
		created. Knowing this, Woosh attempts to display the user-specified
		album date. If the album does not have an album date, it looks 
		for the album's modification date. If it does not have a 
		modification date, it uses the album creation date.</p>
		
		<p>The overall XSLT that generates the title (name and date)
		looks like this:</p>
		
<textarea name="code" rows="1" cols="80" class="xslt">
&lt;xsl:template match="m:album" mode="title"&gt;
	&lt;xsl:value-of select="@name"/&gt;
	&lt;xsl:if test="string-length(@name) &gt; 0"&gt;
		&lt;xsl:text&gt; - &lt;/xsl:text&gt;
	&lt;/xsl:if&gt;
	&lt;xsl:variable name="date"&gt;
		&lt;xsl:choose&gt;
			&lt;xsl:when test="@album-date"&gt;
				&lt;xsl:value-of select="@album-date"/&gt;
			&lt;/xsl:when&gt;
			&lt;xsl:when test="@modify-date"&gt;
				&lt;xsl:value-of select="@modify-date"/&gt;
			&lt;/xsl:when&gt;
			&lt;xsl:when test="@creation-date"&gt;
				&lt;xsl:value-of select="@creation-date"/&gt;
			&lt;/xsl:when&gt;
		&lt;/xsl:choose&gt;
	&lt;/xsl:variable&gt;
	&lt;xsl:value-of select="date:format-date(substring($date, 1, 19), 'yyyy.MM.dd')"/&gt;
&lt;/xsl:template&gt;
</textarea>
	</li>
	<li>
		<p><b>Thumbnail navigation: </b> here Woosh generates 
		thumbnails for all the items in the album dynamically using
		JavaScript on the client's browser. To do this, it generates
		an array of data based on all the items available in the album.
		Matte provides an XSLT template that is useful for this 
		purpose:</p>
		
<textarea name="code" rows="1" cols="80" class="xslt">
&lt;!--
	Template: m:item, mode album-data
	
	Render album data JavaScript array. The data array is ordered 
	as follows:
	
	0: itemId
	1: original width
	2: original height
	3: collection-relative path
	4: name
	5: comment
	6: create date
	7: icon width
	8: icon height
	9: mime type
--&gt;
&lt;xsl:template match="m:item" mode="album-data"&gt;
	&lt;xsl:text&gt;[&lt;/xsl:text&gt;
	&lt;xsl:value-of select="@item-id"/&gt;
	&lt;xsl:text&gt;,&lt;/xsl:text&gt;
	&lt;xsl:value-of select="@width"/&gt;
	&lt;xsl:text&gt;,&lt;/xsl:text&gt;
	&lt;xsl:value-of select="@height"/&gt;
	&lt;xsl:text&gt;,"&lt;/xsl:text&gt;
	&lt;xsl:call-template name="javascript-string"&gt;
		&lt;xsl:with-param name="output-string" select="@path"/&gt;
	&lt;/xsl:call-template&gt;
	&lt;xsl:text&gt;","&lt;/xsl:text&gt;
	&lt;xsl:call-template name="javascript-string"&gt;
		&lt;xsl:with-param name="output-string" select="@name"/&gt;
	&lt;/xsl:call-template&gt;
	&lt;xsl:text&gt;","&lt;/xsl:text&gt;
	&lt;xsl:if test="m:comment"&gt;
		&lt;xsl:call-template name="javascript-string"&gt;
			&lt;xsl:with-param name="output-string" select="normalize-space(m:comment)"/&gt;
		&lt;/xsl:call-template&gt;
	&lt;/xsl:if&gt;
	&lt;xsl:text&gt;","&lt;/xsl:text&gt;
	&lt;xsl:value-of select="date:format-date(substring(@creation-date,1,19),'dd MMM yyyy')"/&gt;
	&lt;xsl:text&gt;",&lt;/xsl:text&gt;
	&lt;xsl:value-of select="@icon-width"/&gt;
	&lt;xsl:text&gt;,&lt;/xsl:text&gt;
	&lt;xsl:value-of select="@icon-height"/&gt;
	&lt;xsl:text&gt;,"&lt;/xsl:text&gt;
	&lt;xsl:value-of select="@mime"/&gt;
	&lt;xsl:text&gt;"]&lt;/xsl:text&gt;
	&lt;xsl:if test="position() != last()"&gt;
		&lt;xsl:text&gt;,&lt;/xsl:text&gt;
	&lt;/xsl:if&gt;
&lt;/xsl:template&gt;
</textarea>

		<p>The way Woosh calls this template is like this:</p>
		
<textarea name="code" rows="1" cols="80" class="xslt">
var imageData = [
[-1,-1,-1,"dummy/path","dummy name","dummy comment","dummy date"],
&lt;xsl:apply-templates select="$display-album/m:item" mode="album-data"/&gt;
];
</textarea>
		
		<p>Which generates JavaScript like this:</p>
		
<textarea name="code" rows="1" cols="80" class="javascript">
var imageData = [
	[-1,-1,-1,"dummy/path","dummy name","dummy comment","dummy date"],
	[8,1024,683,"_6A_1392.jpg","_6A_1392.jpg","","17 Dec 2006",,,"image/jpeg"],
	[10,1024,683,"IMG_0868.jpg","IMG_0868.jpg","","17 Dec 2006",,,"image/jpeg"],
	[12,512,768,"IMG_0848.jpg","IMG_0848.jpg","","17 Dec 2006",,,"image/jpeg"],
	[14,1024,683,"_19_1404.jpg","_19_1404.jpg","","17 Dec 2006",,,"image/jpeg"],
	[16,1024,683,"IMG_0871.jpg","IMG_0871.jpg","","17 Dec 2006",,,"image/jpeg"],
	[18,512,768,"IMG_5164.jpg","IMG_5164.jpg","","17 Dec 2006",,,"image/jpeg"]
	];
</textarea>
		
		<p>In order to generate URLs to Matte resources, such as the 
		thumbnail images, the JavaScript needs to know the server path
		it should use. Matte makes this available to themes, so Woosh
		generates some more JavaScript data to pass this to the client:</p>
		
<textarea name="code" rows="1" cols="80" class="xslt">
&lt;xsl:variable name="root-album" select="/x:x-data/x:x-model/m:model/descendant::m:album[1]"/&gt;
&lt;script type="text/javascript"&gt;
	var albumKey = '&lt;xsl:value-of select="$root-album/@anonymous-key"/&gt;';
	var webContext = '&lt;xsl:value-of select="$web-context"/&gt;';
	var serverName = '&lt;xsl:value-of select="$server-name"/&gt;'
	var serverPort = '&lt;xsl:value-of select="$server-port"/&gt;'
	var myLang = '&lt;xsl:value-of select="$user-locale"/&gt;'
&lt;/script&gt;
</textarea>
		
		<p>Now the client has all the information it needs to dynamically
		generate the thumbnail images. The JavaScript (simplified here)
		looks like this:</p>
		
<textarea name="code" rows="1" cols="80" class="javascript">
var albumKey = '2XlxVfKHja3CFGtMlyG57ofbchw';
var webContext = '/matte';
var serverName = 'localhost'
var serverPort = '8080'
var myLang = 'en_US'
for ( var i = 0; i &lt; imageData.length; i++ ) {
	var data = imageData[i];
	var url = webContext +"/media.do?id="+data[0]
		+"&amp;albumKey=" +albumKey
		+"&amp;size=THUMB_NORMAL&amp;quality=GOOD";
	var alt = data[4] ? data[4] : data[3];
	var img = document.createElement("img");
	img.setAttribute("src", url);
	img.setAttribute("alt", alt);
	img.className = "tb-thumbnail";
	$('slider-container').appendChild(img);
}
</textarea>
	
		<p>Here you can see Woosh is generating &lt;img&gt; elements for each item,
		setting the <code>src</code> attribute to the Matte <code>/media.do</code>
		URL for generating images. Woosh has hard-coded the media size to be a 
		normal sized thumbnail.</p>

	</li>
	<li>
		<p><b>Full size image:</b> The process of generating full-size images is similar
		to how the thumbnails images are generated. Woosh does it in this 
		way (again, simplifed here):</p>
		
<textarea name="code" rows="1" cols="80" class="javascript">
function displayImage(imageNumber) {
	var newImg = document.createElement("img");
	var newImgUrl = webContext 
			+"/media.do?id="+imageData[imageNumber][0]
			+"&amp;albumKey=" +albumKey
			+"&amp;size=" +imgSize 
			+"&amp;quality=" +imgCompress;
	var title = imageData[imageNumber][4]
		? imageData[imageNumber][4]
		: imageData[imageNumber][3];
	newImg.title = title;
	newImg.alt = title;
	newImg.onload = function() {
		handleDisplayImageLoad(newImg, imageNumber);
	}
	newImg.src = newImgUrl;
}

function handleDisplayImageLoad(newImg, imageNumber) {
	$('image-frame').appendChild(newImg);
	updateImageInfo(imageNumber);
}
</textarea>
		
		<p>Note the call to <code>updateImageInfo()</code> at the 
		bottom. We discuss that next.</p>
		
	</li>
	<li>
		<p><b>Image detail information:</b> Matte themes can utilize another 
		URL for generating detailed information about a single media item. 
		The URL is <code>/viewMediaItemInfo.do</code> and Woosh uses this
		via an AJAX call to populate this information here.</p>
		
		<p>The <code>updateImageInfo()</code> method uses the Prototype 
		<code>Ajax.Updater</code> class to call the detail URL and place the
		result into the page. The JavaScript looks like this:</p>
		
<textarea name="code" rows="1" cols="80" class="javascript">
function updateImageInfo(imageNumber) {
	Element.addClassName('ii-imageMetaFrame', 'updating');
	new Ajax.Updater(
		{success : 'ii-imageMetaFrame'}, 
		webContext +'/viewMediaItemInfo.do', 
		{
			method : 'get',
			parameters : "albumKey="+albumKey +"&amp;itemId=" +imageData[imageNumber][0] 
				+"&amp;themeId=" +themeId, 
			onSuccess : function(t) {
				Element.removeClassName('ii-imageMetaFrame', 'updating');
			},
			onComplete : function() {
				workingUpdaterAjaxHandler.manualStop();
			}
		});
}
</textarea>
	
		<p>The <code>@anonymous-key</code> of the album being viewed and 
		the <code>@item-id</code> of the item you want to view the details for 
		are passed to the <code>/viewMediaItemInfo.do</code> URL (as the 
		<code>albumKey</code> and <code>itemId</code> URL parameters, respectively).</p>
	</li>
</ol>

<h2>Next: Detail View</h2>

<p>Continue next with information on how the 
<a href="theme-howto-detail.html">Detail View</a> handles returning
the detailed information for a single item.</p>

<div>
<a href="http://sourceforge.net"><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=103583&amp;type=1" 
	width="88" height="31" alt="SourceForge.net Logo" /></a>
</div>
<script type="text/javascript">
	dp.SyntaxHighlighter.ClipboardSwf = 'js/clipboard.swf';
	dp.SyntaxHighlighter.HighlightAll('code');
</script>
</body>
</html>

